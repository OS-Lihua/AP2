# 交易生命周期

智能体支付协议 (AP2) 为不同的用户场景定义了清晰的流程。两种主要模式是"用户在场"和"用户不在场"。

## 用户在场交易

此流程适用于用户将任务委托给智能体并可以授权最终支付的情况。

典型流程如下：

1. **设置**: 用户可以在其首选的购物智能体和支持的凭证提供方（如其数字钱包）之间建立连接。
2. **发现与协商**: 用户向其智能体提供购物任务。智能体与一个或多个商户交互，组装满足请求的购物车。
3. **商户验证购物车**: 用户授权购买一组商品。商户签署最终购物车，表明其履行承诺。
4. **提供支付方式**: 购物智能体向凭证提供方请求适用的支付方式。
5. **显示购物车**: 智能体在可信界面中向用户展示最终的商户签名购物车和选定的支付方式。
6. **签名与支付**: 用户的批准生成加密签名的**购物车委托书**，其中包含购买的明确详情。此委托书作为证据与商户共享。为支付网络准备单独的**支付委托书**。
7. **支付执行**: 支付详情传达给凭证提供方和商户以完成交易。
8. **发送给发卡方**: 商户或其处理方将交易路由到支付网络和发卡方，附加支付委托书以提供对交易智能体性质的可见性。
9. **质询（如有必要）**: 任何一方（发卡方、商户等）都可以发起质询（如 3D Secure）。用户必须在可信界面上完成质询。
10. **授权**: 发卡方批准支付，确认信息发送给用户和商户，以便订单可以履行。

## 用户不在场交易

此流程适用于用户希望智能体在其不在场的情况下进行支付的场景（例如"价格降到100美元以下时购买这些鞋子"）。

与用户在场流程的主要区别：

1. **捕获意图**: 用户不是批准最终购物车，而是批准智能体对其意图的_理解_。用户的会话内身份验证（如生物识别）创建签名的**意图委托书**。
2. **使用意图委托书**: 此委托书包含用户目标的自然语言描述，与商户共享，商户可以决定是否能够满足请求。
3. **商户可以强制用户确认**: 如果商户基于意图委托书不确定其满足请求的能力，他们可以要求用户返回会话确认详情。这可能涉及用户从一组最终选项中选择（创建购物车委托书）或提供更多信息（更新意图委托书）。

这确保了商户对用户意图有信心，同时仍允许任务的自主执行。
